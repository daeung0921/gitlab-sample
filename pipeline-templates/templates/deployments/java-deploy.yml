# ────────────────────────────────────────────────
# 개발 Snapshot War 통배포
# ────────────────────────────────────────────────
.deploy_war_staging:
  stage: deploy
  variables:
    GIT_STRATEGY: none
    GIT_CHECKOUT: "false"
  environment:
    name: staging
    url: "http://$WAS_URL$CONTEXT_PATH/"
  script:
    - !reference [.fn_tomcat_deploy_snapshot_war, script]
    - fn_tomcat_deploy_snapshot_war
    - unzip -o artifacts/deploy-snapshot-war-artifacts.zip -d deploy-snapshot-war-unpacked
  artifacts:
    name: "deploy-snapshot-war-$CI_PIPELINE_ID"
    paths:
      - deploy-snapshot-war-unpacked/
    expire_in: 1 day

# ────────────────────────────────────────────────
# 운영 Release War 통배포
# ────────────────────────────────────────────────
.deploy_war_prod:
  stage: deploy
  variables:
    GIT_STRATEGY: none
    GIT_CHECKOUT: "false"
  environment:
    name: production
    url: "http://$WAS_URL$CONTEXT_PATH/"
  script:
    - !reference [.fn_tomcat_deploy_war, script]
    - fn_tomcat_deploy_war
    - unzip -o artifacts/deploy-war-artifacts.zip -d deploy-release-war-unpacked
  artifacts:
    name: "deploy-release-war-$CI_PIPELINE_ID"
    paths:
      - deploy-release-war-unpacked/
    expire_in: 1 day


# ────────────────────────────────────────────────
# 운영 Diff 배포
# ────────────────────────────────────────────────
.deploy_diff:
  stage: deploy
  variables:
    #GIT_STRATEGY: none
    #GIT_CHECKOUT: "false"
    HEALTH_MODE: "none"  
    HOT_RELOAD: "false"    
  environment:
    name: production
    url: "http://$WAS_URL$CONTEXT_PATH/"
  script:
    - !reference [.fn_tomcat_diff_remote_hook_custom, script]
    - !reference [.fn_tomcat_diff_remote_hook_slack, script]
    - !reference [.fn_tomcat_diff_remote_hook_dispatcher, script]
    - !reference [.fn_tomcat_diff_deploy, script]
    - fn_tomcat_diff_deploy  
    - unzip -o artifacts/diff-deploy-artifacts.zip -d diff-deploy-unpacked
  artifacts:
    name: "diff-deploy-$CI_PIPELINE_ID"
    paths:
      - diff-deploy-unpacked/
    expire_in: 1 day

# ────────────────────────────────────────────────
# 운영 Symbolic Link 전환 배포
# ────────────────────────────────────────────────
.deploy_symlink_preview:
  stage: staging
  variables: 
    #GIT_STRATEGY: none
    #GIT_CHECKOUT: "false"      
    HEALTH_MODE: "none"  
    HOT_RELOAD: "false" 
  script:
    - !reference [.fn_tomcat_deploy_preview, script]
    - fn_tomcat_deploy_preview
    - unzip -o artifacts/symlink-preview-artifacts.zip -d symlink-preview-unpacked
  artifacts:
    name: "symlink-preview-$CI_PIPELINE_ID"
    paths:
      - symlink-preview-unpacked/
    expire_in: 1 day

.deploy_symlink:
  stage: deploy
  variables: 
    #GIT_STRATEGY: none
    #GIT_CHECKOUT: "false"      
    HEALTH_MODE: "none"  
    HOT_RELOAD: "false"
  environment:
    name: production
    url: "http://$WAS_URL$CONTEXT_PATH/"
  script:
    - !reference [.fn_tomcat_symbolic_deploy, script]
    - fn_tomcat_symbolic_deploy
    - unzip -o artifacts/symlink-deploy-artifacts.zip -d symlink-deploy-unpacked
  artifacts:
    name: "symlink-deploy-$CI_PIPELINE_ID"
    paths:
      - symlink-deploy-unpacked/
    expire_in: 1 day