.approve_rollback:
  stage: rollback
  variables:
    GIT_STRATEGY: none
    GIT_CHECKOUT: "false"
  rules: 
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/'
      when: manual
      allow_failure: false
    - when: never
  manual_confirmation: "Run rollback for $CI_COMMIT_TAG?"
  before_script: []
  variables:
    ROLLBACK: ""
  allow_failure: false
  script: |
    if [ "${ROLLBACK}" = "yes" ]; then
      echo "DO_ROLLBACK=yes" > approve.env
      echo "[INFO] Rollback approved by user"
    else
      echo "DO_ROLLBACK=no" > approve.env
      echo "[INFO] Rollback denied or skipped by user"
    fi
  artifacts:
    reports:
      dotenv: approve.env

.rollback_war:
  stage: rollback
  variables:
    GIT_STRATEGY: none 
    GIT_CHECKOUT: "false"
  #needs:
  #  - job: approve_rollback
  #    artifacts: true
  environment:
    name: production
    url: "http://$WAS_URL$CONTEXT_PATH/"
  script:
    - !reference [.fn_tomcat_rollback_war, script]
    - fn_tomcat_rollback_war
    #- |
    #  if [ "${DO_ROLLBACK:-no}" != "yes" ]; then
    #    echo "[CANCEL] approval says no"
    #    exit 1
    #  else
    #    fn_tomcat_rollback_war
    #  fi

.rollback_diff_restore:
  stage: rollback
  variables:
    GIT_STRATEGY: none
    GIT_CHECKOUT: "false"
  #needs:
  #  - job: approve_rollback
  #    artifacts: true
  environment:
    name: production
    url: "http://$WAS_URL$CONTEXT_PATH/"
  script:
    - !reference [.fn_tomcat_diff_restore, script]
    - fn_tomcat_diff_restore
  #  - |
  #    if [ "${DO_ROLLBACK:-no}" != "yes" ]; then
  #      echo "[CANCEL] approval says no"
  #      exit 1
  #    else
  #      fn_tomcat_diff_restore
  #    fi


# ────────────────────────────────────────────────
# 심링크 롤백
# ────────────────────────────────────────────────
.rollback_symlink:
  stage: rollback      # 혹은 deploy / rollback 전용 stage
  when: manual         # 롤백은 수동 트리거 권장
  allow_failure: false
  variables:
    GIT_STRATEGY: none
    GIT_CHECKOUT: "false"    
    ROLLBACK_TO_VERSION: ""  
    HEALTH_MODE: "none"  
  script:
    - !reference [.fn_tomcat_symbolic_restore, script]
    - fn_tomcat_symbolic_restore
  #artifacts:
  #  name: "rollback-symlink-$CI_COMMIT_TAG"
  #  paths:
  #    - artifacts/symlink-rollback-artifacts.zip
  #  expire_in: 1 day